import ModalView from './components/ModalView.js';

/**
 * Vista de Pagos - Módulo Profesional
 * Maneja la interfaz de cobro con múltiples métodos de pago (Efectivo, QR, Tarjeta)
 */
export default class PaymentView {
    constructor() {
        this.contentArea = document.getElementById('contentArea');
        this.modal = new ModalView();
        
        // Event Handlers placeholders
        this.onNewPayment = null;
        this.onSubmitPayment = null;
        this.onViewPayment = null;
        this.onApplyFilters = null;
    }

    /**
     * Renderiza la vista principal de pagos.
     * @param {Array} payments - Array de pagos a mostrar.
     * @param {Object} summary - Resumen de ingresos.
     */
    render(payments = [], summary = null) {
        this.contentArea.innerHTML = `
            <div class="view-header d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-money-bill-wave"></i> Gestión de Pagos</h2>
                <button id="newPaymentBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Registrar Pago</button>
            </div>

            ${summary ? this.renderSummaryCards(summary) : ''}

            <div class="card shadow-sm border-0 mb-4" style="border-radius: 12px;">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label class="text-secondary small">Fecha Inicio</label>
                            <input type="date" id="filterFechaInicio" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="text-secondary small">Fecha Fin</label>
                            <input type="date" id="filterFechaFin" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <button id="applyFilters" class="btn btn-secondary w-100"><i class="fas fa-filter"></i> Aplicar Filtros</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0" style="border-radius: 12px; overflow: hidden;">
                <div class="table-responsive">
                    <table class="table w-100 mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="p-3 border-bottom text-secondary font-weight-bold text-center" style="width: 10%;">ID</th>
                                <th class="p-3 border-bottom text-secondary font-weight-bold text-center" style="width: 15%;">Orden</th>
                                <th class="p-3 border-bottom text-secondary font-weight-bold text-center" style="width: 20%;">Monto</th>
                                <th class="p-3 border-bottom text-secondary font-weight-bold text-center" style="width: 20%;">Método</th>
                                <th class="p-3 border-bottom text-secondary font-weight-bold text-center" style="width: 20%;">Fecha</th>
                                <th class="p-3 border-bottom text-secondary font-weight-bold text-center" style="width: 15%;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            ${this.renderPaymentRows(payments)}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        this.bindEvents();
    }

    /**
     * Renderiza las tarjetas de resumen.
     */
    renderSummaryCards(summary) {
        return `
            <div class="row mb-4">
                <div class="col-md-6 col-lg-6 mb-3 mb-md-0">
                    <div class="card shadow-sm border-0 bg-primary text-white h-100" style="border-radius: 12px;">
                        <div class="card-body d-flex justify-content-between align-items-center px-4">
                            <div>
                                <h6 class="mb-2 text-white-50 text-uppercase" style="letter-spacing: 1px; font-size: 0.85rem;">Total Ingresos</h6>
                                <h2 class="m-0 font-weight-bold">Bs. ${this.formatCurrency(summary.total_ingresos || 0)}</h2>
                            </div>
                            <div class="icon-circle bg-white-20 rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; background: rgba(255,255,255,0.2);">
                                <i class="fas fa-chart-line fa-2x text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6">
                    <div class="card shadow-sm border-0 bg-white h-100" style="border-radius: 12px;">
                        <div class="card-body d-flex justify-content-between align-items-center px-4">
                            <div>
                                <h6 class="mb-2 text-secondary text-uppercase" style="letter-spacing: 1px; font-size: 0.85rem;">Pagos Registrados</h6>
                                <h2 class="m-0 text-dark font-weight-bold">${summary.total_pagos || 0}</h2>
                            </div>
                            <div class="icon-circle bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="fas fa-receipt fa-2x text-secondary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Renderiza las filas de la tabla de pagos.
     */
    renderPaymentRows(payments) {
        if (!payments || payments.length === 0) {
            return `<tr><td colspan="6" class="text-center p-5 text-secondary">
                <i class="fas fa-inbox fa-3x mb-3 text-muted"></i><br>
                No hay pagos registrados para este periodo.
            </td></tr>`;
        }

        return payments.map(payment => `
            <tr class="hover-bg-light">
                <td class="p-3 border-bottom text-center text-secondary align-middle">#${payment.id}</td>
                <td class="p-3 border-bottom text-center align-middle">
                    <span class="badge badge-light border px-2 py-1" style="font-size: 0.85rem;">ORD-${payment.orden_id}</span>
                </td>
                <td class="p-3 border-bottom text-center font-weight-bold text-success align-middle" style="font-size: 1.1em;">
                    Bs. ${this.formatCurrency(payment.monto)}
                </td>
                <td class="p-3 border-bottom text-center align-middle">
                    <span class="badge badge-pill badge-info px-3 py-2 shadow-sm" style="background-color: #e3f2fd; color: #0277bd; border: none;">
                        <i class="fas fa-wallet mr-1"></i> ${payment.metodo_pago || 'N/A'}
                    </span>
                </td>
                <td class="p-3 border-bottom text-center text-secondary align-middle">
                    <i class="far fa-calendar-alt mr-1"></i> ${this.formatDate(payment.fecha_pago)}
                </td>
                <td class="p-3 border-bottom text-center align-middle">
                    <button class="btn btn-sm btn-light text-primary view-btn shadow-sm mr-1" data-id="${payment.id}" title="Ver Detalle" style="border-radius: 6px;">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    /**
     * Muestra el modal de cobro profesional con 3 pestañas (Efectivo, QR, Tarjeta)
     * @param {Object} order - Orden a cobrar
     */
    showPaymentModal(order) {
        // Validar si la orden puede ser cobrada
        const isFinished = order.estado_nombre === 'Finalizado' || order.estado_nombre === 'Entregado';
        
        if (!isFinished) {
            this.showErrorMessage('No se puede cobrar', `La orden debe estar en estado "Finalizado" o "Entregado" para poder cobrarla.<br>Estado actual: <strong>${order.estado_nombre}</strong>`);
            return;
        }

        const saldoPendiente = order.saldo_pendiente || order.total_estimado;
        const totalOrden = order.total_estimado || 0;
        const totalPagado = order.total_pagado || 0;
        
        const modalContent = `
            <div class="payment-modal">
                <!-- Header con información de la orden -->
                <div class="payment-header p-4 bg-light border-bottom">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-1">Orden #${order.id}</h5>
                            <p class="text-secondary mb-0">
                                <i class="fas fa-car mr-1"></i> ${order.placa || 'N/A'} - ${order.marca || ''} ${order.modelo || ''}
                            </p>
                        </div>
                        <div class="col-md-6 text-md-right">
                            <h3 class="mb-0 text-primary">Bs. ${this.formatCurrency(totalOrden)}</h3>
                            <small class="text-secondary">Total de la orden</small>
                        </div>
                    </div>
                    ${totalPagado > 0 ? `
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="fas fa-info-circle mr-1"></i>
                            Ya se han pagado <strong>Bs. ${this.formatCurrency(totalPagado)}</strong>
                            - Saldo pendiente: <strong>Bs. ${this.formatCurrency(saldoPendiente)}</strong>
                        </div>
                    ` : ''}
                </div>

                <!-- Tabs de métodos de pago -->
                <ul class="nav nav-tabs px-4 pt-3 border-0" role="tablist" style="background: #fafafa;">
                    <li class="nav-item">
                        <a class="nav-link active" id="cash-tab" data-toggle="tab" href="#cash" role="tab">
                            <i class="fas fa-money-bill-wave mr-1"></i> Efectivo
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="qr-tab" data-toggle="tab" href="#qr" role="tab">
                            <i class="fas fa-qrcode mr-1"></i> QR
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="card-tab" data-toggle="tab" href="#card" role="tab">
                            <i class="fas fa-credit-card mr-1"></i> Tarjeta
                        </a>
                    </li>
                </ul>

                <!-- Tab content -->
                <div class="tab-content p-4">
                    <!-- Efectivo Tab -->
                    <div class="tab-pane fade show active" id="cash" role="tabpanel">
                        ${this.renderCashPaymentTab(order, saldoPendiente)}
                    </div>

                    <!-- QR Tab -->
                    <div class="tab-pane fade" id="qr" role="tabpanel">
                        ${this.renderQRPaymentTab(order, saldoPendiente)}
                    </div>

                    <!-- Tarjeta Tab -->
                    <div class="tab-pane fade" id="card" role="tab panel">
                        ${this.renderCardPaymentTab(order, saldoPendiente)}
                    </div>
                </div>
            </div>
        `;

        this.modal.open(`Cobrar - Orden #${order.id}`, modalContent);
        this.attachPaymentModalEvents(order, saldoPendiente);
    }

    /**
     * Renderiza la pestaña de pago en Efectivo
     */
    renderCashPaymentTab(order, saldoPendiente) {
        return `
            <div class="cash-payment">
                <div class="form-group">
                    <label class="font-weight-bold">Monto a Cobrar (Bs)</label>
                    <input type="number" id="cash-amount" class="form-control form-control-lg" 
                           value="${saldoPendiente.toFixed(2)}" step="0.01" min="0" 
                           max="${saldoPendiente.toFixed(2)}" style="font-size: 1.3rem;">
                    <small class="text-secondary">Máximo: Bs. ${this.formatCurrency(saldoPendiente)}</small>
                </div>

                <div class="form-group mt-4">
                    <label class="font-weight-bold">Monto Recibido (Bs)</label>
                    <input type="number" id="cash-received" class="form-control form-control-lg" 
                           placeholder="0.00" step="0.01" min="0" style="font-size: 1.3rem;">
                </div>

                <div class="alert alert-secondary mt-4" id="cash-change-display" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="font-weight-bold">Cambio a devolver:</span>
                        <h3 class="mb-0 text-success" id="cash-change-amount">Bs. 0.00</h3>
                    </div>
                </div>

                <button id="cash-pay-btn" class="btn btn-success btn-lg btn-block mt-4" disabled>
                    <i class="fas fa-check-circle mr-2"></i> Confirmar Pago en Efectivo
                </button>
            </div>
        `;
    }

    /**
     * Renderiza la pestaña de pago con QR
     */
    renderQRPaymentTab(order, saldoPendiente) {
        return `
            <div class="qr-payment text-center">
                <div class="form-group">
                    <label class="font-weight-bold">Monto a Cobrar (Bs)</label>
                    <input type="number" id="qr-amount" class="form-control form-control-lg text-center" 
                           value="${saldoPendiente.toFixed(2)}" step="0.01" min="0" 
                           max="${saldoPendiente.toFixed(2)}" style="font-size: 1.5rem; font-weight: bold;">
                </div>

                <div class="qr-code-container mt-4 p-4 bg-white border rounded" style="display: inline-block;">
                    <div id="qr-code" class="mb-3"></div>
                    <p class="text-secondary mb-0"><small>Escanea el código QR con tu aplicación de pago</small></p>
                </div>

                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle mr-1"></i>
                    El cliente debe escanear el código y confirmar el pago en su aplicación bancaria.
                </div>

                <button id="qr-verify-btn" class="btn btn-primary btn-lg btn-block mt-4">
                    <i class="fas fa-search mr-2"></i> Verificar Transferencia
                </button>
            </div>
        `;
    }

    /**
     * Renderiza la pestaña de pago con Tarjeta
     */
    renderCardPaymentTab(order, saldoPendiente) {
        return `
            <div class="card-payment">
                <div class="form-group">
                    <label class="font-weight-bold">Monto a Cobrar (Bs)</label>
                    <input type="number" id="card-amount" class="form-control form-control-lg" 
                           value="${saldoPendiente.toFixed(2)}" step="0.01" min="0" 
                           max="${saldoPendiente.toFixed(2)}" style="font-size: 1.3rem;">
                </div>

                <div class="form-group mt-4">
                    <label class="font-weight-bold">Número de Tarjeta</label>
                    <input type="text" id="card-number" class="form-control form-control-lg" 
                           placeholder="1234 5678 9012 3456" maxlength="19" 
                           style="font-size: 1.2rem; letter-spacing: 2px;">
                    <small class="text-secondary">Solo para simulación - No almacenamos datos reales</small>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="font-weight-bold">Fecha de Expiración</label>
                            <input type="text" id="card-expiry" class="form-control" 
                                   placeholder="MM/AA" maxlength="5">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="font-weight-bold">CVV</label>
                            <input type="text" id="card-cvv" class="form-control" 
                                   placeholder="123" maxlength="3">
                        </div>
                    </div>
                </div>

                <button id="card-pay-btn" class="btn btn-success btn-lg btn-block mt-4" disabled>
                    <i class="fas fa-credit-card mr-2"></i> Procesar Pago con Tarjeta
                </button>
            </div>
        `;
    }

    /**
     * Adjunta eventos al modal de pagos
     */
    attachPaymentModalEvents(order, saldoPendiente) {
        // === EFECTIVO - Cálculo de cambio en tiempo real ===
        const cashAmount = document.getElementById('cash-amount');
        const cashReceived = document.getElementById('cash-received');
        const cashChangeDisplay = document.getElementById('cash-change-display');
        const cashChangeAmount = document.getElementById('cash-change-amount');
        const cashPayBtn = document.getElementById('cash-pay-btn');

        const updateCashChange = () => {
            const amount = parseFloat(cashAmount.value) || 0;
            const received = parseFloat(cashReceived.value) || 0;
            
            if (received >= amount && amount > 0) {
                const change = received - amount;
                cashChangeAmount.textContent = `Bs. ${this.formatCurrency(change)}`;
                cashChangeDisplay.style.display = 'block';
                cashPayBtn.disabled = false;
            } else {
                cashChangeDisplay.style.display = 'none';
                cashPayBtn.disabled = true;
            }
        };

        if (cashAmount && cashReceived) {
            cashAmount.addEventListener('input', updateCashChange);
            cashReceived.addEventListener('input', updateCashChange);
        }

        // Botón de pago en efectivo
        if (cashPayBtn) {
            cashPayBtn.addEventListener('click', () => {
                const amount = parseFloat(cashAmount.value);
                this.processPayment(order.id, amount, 'Efectivo', '');
            });
        }

        // === QR - Generar código QR y verificar ===
        this.generateQRCode(order.id, saldoPendiente);

        const qrVerifyBtn = document.getElementById('qr-verify-btn');
        if (qrVerifyBtn) {
            qrVerifyBtn.addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('qr-amount').value);
                this.simulateQRVerification(order.id, amount);
            });
        }

        // === TARJETA - Validación de formato y procesamiento ===
        this.setupCardValidation();

        const cardPayBtn = document.getElementById('card-pay-btn');
        if (cardPayBtn) {
            cardPayBtn.addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('card-amount').value);
                this.simulateCardPayment(order.id, amount);
            });
        }
    }

    /**
     * Genera un código QR simple
     */
    generateQRCode(orderId, amount) {
        const qrContainer = document.getElementById('qr-code');
        if (qrContainer) {
            // Simulación simple con placeholder - en producción usar qrcode.js
            qrContainer.innerHTML = `
                <div style="width: 200px; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 2px solid #ddd;">
                    <div style="text-align: center;">
                        <i class="fas fa-qrcode fa-5x text-secondary"></i>
                        <p class="mt-2 mb-0 small text-secondary">QR Simulado</p>
                        <p class="mb-0 small"><strong>Bs. ${this.formatCurrency(amount)}</strong></p>
                    </div>
                </div>
            `;
            
            // En producción, usar qrcode.js:
            // new QRCode(qrContainer, {
            //     text: `taller-payment://order/${orderId}?amount=${amount}`,
            //     width: 200,
            //     height: 200
            // });
        }
    }

    /**
     * Configura la validación de tarjeta en tiempo real
     */
    setupCardValidation() {
        const cardNumber = document.getElementById('card-number');
        const cardExpiry = document.getElementById('card-expiry');
        const cardCVV = document.getElementById('card-cvv');
        const cardPayBtn = document.getElementById('card-pay-btn');

        // Formatear número de tarjeta con espacios cada 4 dígitos
        if (cardNumber) {
            cardNumber.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/g, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
                this.validateCardForm(cardPayBtn);
            });
        }

        // FFormatear fecha de expiración MM/AA
        if (cardExpiry) {
            cardExpiry.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
                this.validateCardForm(cardPayBtn);
            });
        }

        // CVV solo números
        if (cardCVV) {
            cardCVV.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
                this.validateCardForm(cardPayBtn);
            });
        }
    }

    /**
     * Valida el formulario de tarjeta
     */
    validateCardForm(submitBtn) {
        const cardNumber = document.getElementById('card-number');
        const cardExpiry = document.getElementById('card-expiry');
        const cardCVV = document.getElementById('card-cvv');

        const isValid = 
            cardNumber && cardNumber.value.replace(/\s/g, '').length === 16 &&
            cardExpiry && cardExpiry.value.length === 5 &&
            cardCVV && cardCVV.value.length === 3;

        if (submitBtn) {
            submitBtn.disabled = !isValid;
        }
    }

    /**
     * Simula la verificación de pago QR con spinner y animación de éxito
     */
    async simulateQRVerification(orderId, amount) {
        const qrVerifyBtn = document.getElementById('qr-verify-btn');
        const originalHTML = qrVerifyBtn.innerHTML;

        // Mostrar spinner
        qrVerifyBtn.disabled = true;
        qrVerifyBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm mr-2"></span>
            Verificando transferencia con el banco...
        `;

        // Simular delay de 2 segundos
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Procesar pago
        this.processPayment(orderId, amount, 'QR', `QR-${Date.now()}`);
    }

    /**
     * Simula el procesamiento de pago con tarjeta
     */
    async simulateCardPayment(orderId, amount) {
        const cardPayBtn = document.getElementById('card-pay-btn');
        const originalHTML = cardPayBtn.innerHTML;

        // Mostrar spinner
        cardPayBtn.disabled = true;
        cardPayBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm mr-2"></span>
            Procesando pago con el banco...
        `;

        // Simular delay de 2 segundos
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Procesar pago
        const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
        const reference = `CARD-${cardNumber.substring(12)}`;
        this.processPayment(orderId, amount, 'Tarjeta', reference);
    }

    /**
     * Procesa el pago y muestra animación de éxito
     */
    processPayment(orderId, amount, metodo, reference) {
        // Cerrar modal actual
        this.modal.close();

        // Mostrar animación de éxito
        this.showSuccessAnimation(amount, metodo);

        // Llamar al handler si está definido
        if (this.onSubmitPayment) {
            this.onSubmitPayment({
                orden_id: orderId,
                monto: amount,
                metodo_pago: metodo,
                referencia: reference
            });
        }
    }

    /**
     * Muestra animación de éxito con check verde
     */
    showSuccessAnimation(amount, metodo) {
        const successHTML = `
            <div class="payment-success text-center p-5">
                <div class="success-checkmark mb-4">
                    <div class="check-icon">
                        <span class="icon-line line-tip"></span>
                        <span class="icon-line line-long"></span>
                        <div class="icon-circle"></div>
                        <div class="icon-fix"></div>
                    </div>
                </div>
                <h2 class="text-success mb-3">¡Pago Registrado!</h2>
                <p class="text-secondary mb-4">
                    El pago de <strong>Bs. ${this.formatCurrency(amount)}</strong> 
                    mediante <strong>${metodo}</strong> ha sido registrado exitosamente.
                </p>
                <button class="btn btn-primary" onclick="document.querySelector('.modal-overlay')?.remove()">
                    Cerrar
                </button>
            </div>

            <style>
                .success-checkmark {
                    width: 80px;
                    height: 80px;
                    margin: 0 auto;
                }
                
                .check-icon {
                    width: 80px;
                    height: 80px;
                    position: relative;
                    border-radius: 50%;
                    box-sizing: content-box;
                    border: 4px solid #4CAF50;
                }
                
                .icon-line {
                    height: 5px;
                    background-color: #4CAF50;
                    display: block;
                    border-radius: 2px;
                    position: absolute;
                    z-index: 10;
                }
                
                .line-tip {
                    top: 46px;
                    left: 14px;
                    width: 25px;
                    transform: rotate(45deg);
                    animation: icon-line-tip 0.75s;
                }
                
                .line-long {
                    top: 38px;
                    right: 8px;
                    width: 47px;
                    transform: rotate(-45deg);
                    animation: icon-line-long 0.75s;
                }
                
                .icon-circle {
                    top: -4px;
                    left: -4px;
                    z-index: 10;
                    width: 80px;
                    height: 80px;
                    border-radius: 50%;
                    position: absolute;
                    box-sizing: content-box;
                    border: 4px solid rgba(76, 175, 80, .5);
                }
                
                .icon-fix {
                    top: 8px;
                    width: 5px;
                    left: 26px;
                    z-index: 1;
                    height: 85px;
                    position: absolute;
                    transform: rotate(-45deg);
                    background-color: #fff;
                }
                
                @keyframes icon-line-tip {
                    0% { width: 0; left: 1px; top: 19px; }
                    54% { width: 0; left: 1px; top: 19px; }
                    70% { width: 50px; left: -8px; top: 37px; }
                    84% { width: 17px; left: 21px; top: 48px; }
                    100% { width: 25px; left: 14px; top: 46px; }
                }
                
                @keyframes icon-line-long {
                    0% { width: 0; right: 46px; top: 54px; }
                    65% { width: 0; right: 46px; top: 54px; }
                    84% { width: 55px; right: 0px; top: 35px; }
                    100% { width: 47px; right: 8px; top: 38px; }
                }
            </style>
        `;

        this.modal.open('', successHTML);

        // Auto-cerrar después de 3 segundos
        setTimeout(() => {
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) overlay.remove();
        }, 3000);
    }

    /**
     * Muestra mensaje de error
     */
    showErrorMessage(title, message) {
        const errorHTML = `
            <div class="text-center p-4">
                <div class="mb-4">
                    <i class="fas fa-exclamation-triangle fa-4x text-warning"></i>
                </div>
                <h4>${title}</h4>
                <p class="text-secondary">${message}</p>
                <button class="btn btn-secondary mt-3" onclick="document.querySelector('.modal-overlay')?.remove()">
                    Cerrar
                </button>
            </div>
        `;
        this.modal.open(title, errorHTML);
    }

    /**
     * Formatea una fecha.
     */
    formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('es-BO', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    /**
     * Formatea un valor monetario.
     */
    formatCurrency(amount) {
        return (amount || 0).toLocaleString('es-BO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    bindEvents() {
        const newPaymentBtn = document.getElementById('newPaymentBtn');
        if (newPaymentBtn) {
            newPaymentBtn.addEventListener('click', () => {
                if (this.onNewPayment) this.onNewPayment();
            });
        }

        const applyFiltersBtn = document.getElementById('applyFilters');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', () => {
                const fechaInicio = document.getElementById('filterFechaInicio').value;
                const fechaFin = document.getElementById('filterFechaFin').value;
                if (this.onApplyFilters) this.onApplyFilters({ fecha_inicio: fechaInicio, fecha_fin: fechaFin });
            });
        }

        // Delegación de eventos para botones en la tabla
        const tableBody = document.getElementById('paymentsTableBody');
        if (tableBody) {
            tableBody.addEventListener('click', (e) => {
                const viewBtn = e.target.closest('.view-btn');
                if (viewBtn) {
                    const id = viewBtn.dataset.id;
                    if (this.onViewPayment) this.onViewPayment(id);
                }
            });
        }
    }

    bindNewPayment(handler) {
        this.onNewPayment = handler;
    }

    bindSubmitPayment(handler) {
        this.onSubmitPayment = handler;
    }
    
    bindViewPayment(handler) {
        this.onViewPayment = handler;
    }

    bindApplyFilters(handler) {
        this.onApplyFilters = handler;
    }
}
